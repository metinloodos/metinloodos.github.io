'use client';

import React, { useEffect } from 'react';

import Loading from '@/components/loading';

import { getStatusData } from '@/services';
import { AxiosResponse } from '@/services/types';

import { useSearchParams } from 'next/navigation';

import { sendPageTrigger } from '@/helpers/event-trigger';
import { PlatformType } from '@/app/enum';

export default function RedirectLogin() {
  const searchParams = useSearchParams();

  const getData = async (transactionId: string, isNewUser: string, platform: string) => {
    const newUser = isNewUser === 'true' || isNewUser === 'True';
    const response: AxiosResponse = await getStatusData(`?transactionId=${transactionId}&status=true`);
    const { data } = response;
    const { friendlyMessage, payload } = data;

    if (payload.successUrl && platform !== PlatformType.Android) {
      (window as any).location.href = payload.successUrl;
    } else {
      await sendPageTrigger({
        status: 'success',
        isNewUser: newUser,
        userMessage: friendlyMessage?.title ?? '',
      });

      if (newUser) {
        if (platform === PlatformType.Android) {
          (window as any).location.href =
            `https://redirect.sappd.alisgidis.com/android-presuccess?transactionId=${transactionId}`;
        } else {
          (window as any).location.href = `https://sappd.alisgidis.com/result/success/${transactionId}`;
        }
      } else {
        if (platform === PlatformType.Android) {
          if (payload.successUrl) {
            (window as any).location.href =
              `https://redirect.sappd.alisgidis.com/android-success-url?transactionId=${transactionId}&successUrl=${payload.successUrl}`;
          } else {
            (window as any).location.href =
              `https://redirect.sappd.alisgidis.com/android-success?transactionId=${transactionId}`;
          }
        } else {
          (window as any).location.href = `https://sappd.alisgidis.com/result/success/${transactionId}`;
        }
      }
    }
  };

  useEffect(() => {
    const transactionId = searchParams.get('transactionId') ?? '';
    const isNewUser = searchParams.get('isNewUser') ?? '';
    const platform = searchParams.get('platform') ?? '';
    getData(transactionId, isNewUser, platform);
  }, []);

  return <Loading />;
}
